#!/usr/bin/env bash

# A small piece of logic that runs when the session starts.
# Nothing much is happening here right now, but in the future, 
# I think it will be possible to implement something like self-check for the entire setup.

source "$VIBRANIUM_PATH/vibranium-core-lib"

[[ ! -d "$VIBRANIUM_STATE" ]] && mkdir "$VIBRANIUM_STATE"

if [[ -f "$VIBRANIUM_STATE/first-boot" ]]; then
	vibranium-utils-first-boot
fi

if [[ ! -f "$VIBRANIUM_STATE/night-light" ]]; then
	echo "suspended" > "$VIBRANIUM_STATE/night-light"
fi

if [[ ! -d "$VIBRANIUM_STATE/wallpaper" ]]; then
	mkdir -p "$VIBRANIUM_STATE"/wallpaper
	vibranium-utils-wallpaper-get > "$VIBRANIUM_STATE/wallpaper/$(vibranium-theme-get)"
fi

# ddcutil (external monitor brightness control)
if [[ $VIBRANIUM_BRIGHTNESS_USE_DDC_CONTROL == true ]]; then
	export I2C_BUS; I2C_BUS=$(ddcutil detect 2> /dev/null | awk -F'i2c-' '/I2C bus/{print $2}')
fi

CHASSIS="$(</sys/class/dmi/id/chassis_type)"

# So far, this variable has little use
if [[ "$CHASSIS" == "10" ]]; then
	export VIBRANIUM_IS_LAPTOP=true
else
	export VIBRANIUM_IS_LAPTOP=false
fi

if [[ "$CHASSIS" == "1" ]]; then
	export VIBRANIUM_IS_VIRTUAL_MACHINE=true
else
	export VIBRANIUM_IS_VIRTUAL_MACHINE=false
fi

if lspci | grep -qE "AMD/ATI|Intel"; then
	export VIBRANIUM_GPU_IS_SUPPORTED=true
else
	export VIBRANIUM_GPU_IS_SUPPORTED=false
fi
